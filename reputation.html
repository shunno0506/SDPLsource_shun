<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>分析ダッシュボード</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .dashboard{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .panel{padding:14px}
    .stat{display:flex;gap:12px;align-items:center}
    .stat .num{font-size:1.6rem;font-weight:700}
    .chart{background:#fff;padding:12px;border-radius:8px}
  </style>
   	<script src="js/auth.js" defer></script>
   	<script src="js/storage.js" defer></script>
   	<script src="js/analytics.js" defer></script>
</head>
<body>
  	<script>if(window.simpleAuth) window.simpleAuth.requireAuth();</script>
  <a href="home.html" class="global-back">← ホーム</a>
  <div class="container">
    <header>
      <h1>分析ダッシュボード</h1>
      <div class="lead">ダッシュボード（デモ）: 週間集計・クレーム種別・売上推移 を表示します</div>
      <div style="margin-top:10px">
      </div>
    </header>

    <main class="dashboard">
      <section class="card panel">
        <h2>週間売上推移</h2>
        <div class="chart" id="salesChart" style="height:220px"></div>

        <h2 style="margin-top:18px">クレーム種別</h2>
        <div id="claimList" class="chart"></div>
      </section>

      <aside class="card panel">
        <h3>主要指標</h3>
        <div class="stat"><div class="num" id="totalSales">¥0</div><div>今週合計売上</div></div>
        <div class="stat"><div class="num" id="avgCustomers">0</div><div>1日平均客数</div></div>
          </aside>

      <!-- カレンダー埋め込み（全幅） -->
      <section class="card panel" style="grid-column:1 / -1; margin-top: 8px;">
        <h2>カレンダー</h2>
        <iframe src="calendar.html" title="カレンダー"
                style="width:100%;height:560px;border:0;border-radius:8px;background:#fff"></iframe>
        <div style="margin-top:8px">
          <a href="calendar.html" class="btn secondary">別タブで開く</a>
        </div>
      </section>
    </main>
  </div>

  <script>
    const wdLabels = ['日','月','火','水','木','金','土'];

    function draw(){
      const salesArr = (window.appStorage? window.appStorage.getSales():[]);
      const reports = (window.appStorage? window.appStorage.getReports():[]);

      // 曜日別売上合計
      const sums = window.appAnalytics? window.appAnalytics.sumSalesByWeekday(salesArr):[0,0,0,0,0,0,0];
      const container = document.getElementById('salesChart');
      container.innerHTML = '';
      const max = Math.max(1, ...sums);
      const barWrap = document.createElement('div');
      barWrap.style.display='flex';barWrap.style.alignItems='end';barWrap.style.height='100%';barWrap.style.gap='6px';
      for(let i=0;i<7;i++){
        const v = sums[i];
        const bar = document.createElement('div');
        const ph = Math.round(v/max*100);
        bar.style.height = ph+'%';
        bar.style.flex = '1 1 0';
        bar.style.background = 'linear-gradient(180deg,#0078d4,#005a9e)';
        bar.title = wdLabels[i] + ' ' + v.toLocaleString();
        bar.style.borderRadius='6px 6px 0 0';
        barWrap.appendChild(bar);
      }
      container.appendChild(barWrap);

      // クレーム/故障/事故などの件数
      const el = document.getElementById('claimList');
      el.innerHTML = '';
      const types = ['クレーム','故障','事故','賛辞','その他'];
      types.forEach(t=>{
        const n = reports.filter(r=>r.eventType===t).length;
        if(n>0){
          const row = document.createElement('div');
          row.style.display='flex';row.style.justifyContent='space-between';row.style.padding='6px 0';
          row.innerHTML = `<div>${t}</div><div>${n} 件</div>`;
          el.appendChild(row);
        }
      });

      // 指標
      const totalSales = salesArr.reduce((a,s)=>a+(Number(s.amount)||0),0);
      const avgCustomers = salesArr.length>0 ? Math.round(salesArr.reduce((a,s)=>a+(Number(s.customers)||0),0)/salesArr.length) : 0;
      document.getElementById('totalSales').textContent = '¥' + totalSales.toLocaleString();
      document.getElementById('avgCustomers').textContent = avgCustomers;
    }

    // Defer external scripts (storage/analytics) execute before DOMContentLoaded,
    // so run draw on DOMContentLoaded to ensure availability and layout ready.
    window.addEventListener('DOMContentLoaded', draw);
    // Refresh when returning to the tab or when localStorage changes from another tab
    window.addEventListener('focus', draw);
    window.addEventListener('storage', draw);
  </script>
</body>
</html>
