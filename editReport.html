<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>日報を編集</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="js/auth.js" defer></script>
  <script src="js/storage.js" defer></script>
</head>
<body>
  <script>if(window.simpleAuth) window.simpleAuth.requireAuth();</script>
  <a href="dailyHome.html" class="global-back">← 日報メニュー</a>
  <div class="wrap">
    <h1>日報を編集</h1>
    <p class="hint">日付は作成時のまま固定です。未選択の写真は現状維持、選択すると差し替えます。</p>

    <form id="editForm">
      <input type="hidden" id="reportId" />
      <div class="row">
        <div class="col">
          <label class="required">従業員ID</label>
          <input type="text" id="employeeId" required />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label class="required">日付（変更不可）</label>
          <input type="text" id="date" readonly />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label class="required">作業分類</label>
          <select id="role" required>
            <option value="">-- 分類を選択 --</option>
            <option>厨房</option>
            <option>ホール</option>
            <option>レジ</option>
            <option>店外</option>
            <option>設備</option>
            <option>その他</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label class="required">事象分類</label>
          <select id="eventType" required>
            <option value="">-- 事象を選択 --</option>
            <option>事故</option>
            <option>故障</option>
            <option>クレーム</option>
            <option>賛辞</option>
            <option>その他</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col full-width">
          <label>メモ</label>
          <textarea id="notes" rows="6"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="col full-width">
          <label>写真（任意・1枚）</label>
          <input type="file" id="photo" accept="image/*" />
          <div class="photo-preview" id="preview"></div>
          <div class="field-note">現状の写真は下に表示。新しい写真を選ぶと置換します。</div>
        </div>
      </div>
      <div class="actions">
        <button type="button" class="btn" id="saveBtn">保存</button>
        <a class="btn secondary" style="text-decoration:none" href="dailyHome.html">キャンセル</a>
      </div>
    </form>
  </div>

  <script>
    function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
    function load(){
      const id = qs('id');
      const r = window.appStorage ? window.appStorage.getReportById(id) : null;
      if(!r){ alert('日報が見つかりません'); location.href = 'dailyHome.html'; return; }
      document.getElementById('reportId').value = r.id;
      document.getElementById('employeeId').value = r.employeeId || '';
      document.getElementById('date').value = r.date || '';
      document.getElementById('role').value = r.role || '';
      document.getElementById('eventType').value = r.eventType || '';
      document.getElementById('notes').value = r.notes || '';
      const p = document.getElementById('preview');
      p.innerHTML = '';
      if(r.photos && r.photos[0]){
        const img = document.createElement('img');
        img.src = r.photos[0].dataUrl;
        img.alt = r.photos[0].name || 'photo';
        p.appendChild(img);
      }
    }

    async function save(){
      const id = document.getElementById('reportId').value;
      const base = window.appStorage ? window.appStorage.getReportById(id) : null;
      if(!base){ alert('保存対象が見つかりません'); return; }
      const upd = {
        id,
        employeeId: document.getElementById('employeeId').value.trim(),
        role: document.getElementById('role').value,
        eventType: document.getElementById('eventType').value,
        notes: document.getElementById('notes').value
      };
      // 写真: 新しく選択されていれば置換、なければ現状維持
      const f = document.getElementById('photo').files;
      if(f && f.length>0){
        const file = f[0];
        const reader = new FileReader();
        reader.onload = e => {
          upd.photos = [{ name: file.name, dataUrl: e.target.result }];
          finalize(upd);
        };
        reader.readAsDataURL(file);
      }else{
        // 変更なし
        upd.photos = base.photos || [];
        finalize(upd);
      }
    }
    function finalize(upd){
      if(!upd.employeeId){ alert('従業員IDは必須です'); return; }
      const saved = window.appStorage.updateReport(upd);
      if(saved){
        alert('日報を更新しました');
        location.href = 'dailyHome.html';
      }else{
        alert('更新に失敗しました');
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      load();
      document.getElementById('saveBtn').addEventListener('click', save);
    });
  </script>
</body>
</html>
