<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>日報メニュー</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="js/auth.js" defer></script>
  <script src="js/storage.js" defer></script>
</head>
<body>
   <script>if(window.simpleAuth) window.simpleAuth.requireAuth();</script>
  <a href="home.html" class="global-back">← ホーム</a>
  <div class="wrap">
    <header>
      <h1>日報メニュー</h1>
    </header>
    <div class="desc">ここから「日報作成」または「売上登録」へ進みます。実運用では店舗・担当選択のあとに実際の入力フォームを表示します。</div>

    <main class="grid" role="main">
      <section class="panel" aria-labelledby="create-title">
        <h2 id="create-title">日報作成</h2>
        <p>店舗で発生した事象（事故・故障・クレーム・賛辞など）を記録する画面へ進みます。写真添付も可能。</p>
  <a href="makeReport.html" class="action" id="create-btn">日報を作成する</a>
      </section>

      <section class="panel" aria-labelledby="sales-title">
        <h2 id="sales-title">売上登録</h2>
        <p>日毎の売上（現金・クレジット・商品券・違算）や客数を簡単に入力します。管理者の集計に役立ちます。</p>
  <a href="sales.html" class="action" id="sales-btn">売上を登録する</a>
      </section>
    </main>

    <section class="panel" aria-labelledby="today-title" style="margin-top:16px">
      <h2 id="today-title">今日作成した日報</h2>
      <div id="todayReports" class="list"></div>
      <div class="field-note">本日分のみ表示します。詳細は別タブで開きます。</div>
    </section>

    <section class="panel" aria-labelledby="past-title" style="margin-top:16px">
      <h2 id="past-title">過去の日報（検索・編集）</h2>
      <p>期間や条件で絞り込み、一覧から編集・削除ができます。</p>
      <a href="reports.html" class="action">過去の日報を検索・編集</a>
    </section>

  <!-- global back button at top-left handles navigation -->
  </div>

  <script>
    // ナビゲーションは anchor の href により行われる。追加の JS は不要だが、フォールバックを残す。
    document.getElementById('create-btn').addEventListener('click',function(e){ /* navigation by href */ });
    document.getElementById('sales-btn').addEventListener('click',function(e){ /* navigation by href */ });

    function fmtToday(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function renderToday(){
      const box = document.getElementById('todayReports');
      if(!box) return;
      const all = (window.appStorage && window.appStorage.getReports) ? window.appStorage.getReports() : [];
      const today = fmtToday();
      const list = all.filter(r=>r.date===today).sort((a,b)=> (a.employeeId||'').localeCompare(b.employeeId||''));
      if(list.length===0){ box.innerHTML = '<div class="empty">本日作成された日報はありません</div>'; return; }
      const frag = document.createDocumentFragment();
      list.forEach(r=>{
        const row = document.createElement('div');
        row.className = 'item';
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr auto auto auto';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${r.employeeId||''}</strong> / ${r.role||''} / ${r.eventType||''} <span style="color:#666">${r.date||''}</span>`;
        const detail = document.createElement('a');
        detail.className = 'btn secondary';
        detail.textContent = '詳細';
        detail.href = `report.html?id=${encodeURIComponent(r.id)}`;
        detail.target = '_blank';
        const edit = document.createElement('a');
        edit.className = 'btn secondary';
        edit.textContent = '編集';
        edit.href = `editReport.html?id=${encodeURIComponent(r.id)}`;
        const del = document.createElement('button');
        del.className = 'btn danger';
        del.textContent = '削除';
        del.addEventListener('click', ()=>{
          if(confirm('この日報を削除しますか？')){
            if(window.appStorage && window.appStorage.deleteReport){
              const ok = window.appStorage.deleteReport(r.id);
              if(ok){
                renderToday();
              }else{
                alert('削除に失敗しました');
              }
            }
          }
        });
        row.appendChild(left);
        row.appendChild(detail);
        row.appendChild(edit);
        row.appendChild(del);
        frag.appendChild(row);
      });
      box.innerHTML = '';
      box.appendChild(frag);
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      renderToday();
      window.addEventListener('focus', renderToday);
      window.addEventListener('storage', renderToday);
    });
  </script>
</body>
</html>